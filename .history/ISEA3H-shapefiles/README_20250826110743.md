This repository contains shapefiles for the ISEA3H grid at resolutions 1-9. The shapefiles were generated using the java [geogrid](https://github.com/mocnik-science/geogrid) library, [dggridR](https://github.com/r-barnes/dggridR) and the [sf](https://r-spatial.github.io/sf/) package. 

**resolution 6** 

![resolution 6](grid_6.svg)

For most applications, it is unlikely that a resolution higher than 9 will be needed. Here is a table showing the number of cells at each resolution:

| resolution| n_cells|
|----------:|-------:|
|          1|      32|
|          2|      92|
|          3|     272|
|          4|     812|
|          5|    2432|
|          6|    7292|
|          7|   21872|
|          8|   65612|
|          9|  196832|

These shapefiles are intended to be used with GBIF SQL downloads. 

> It is not possible to use the `dggridR` package directly with GBIF SQL downloads because GBIF uses **geogrid** ids instead of the **seqnum** used by `dggridR`.  

## Using the Shapefiles

Here is an example of how to use the shapefiles with GBIF SQL downloads and rgbif: 

```R
library(rgbif)
library(sf)
library(dplyr)
library(ggplot2)

sql <-
"
SELECT 
  GBIF_ISEA3HCode(
    6, 
    decimalLatitude,
    decimalLongitude,
    COALESCE(coordinateUncertaintyInMeters, 1000) 
  ) AS geogrid_id,
  COUNT(DISTINCT speciesKey) AS unique_species_count
FROM
  occurrence
  WHERE hasCoordinate = TRUE
  AND (coordinateUncertaintyInMeters <= 1000 OR coordinateUncertaintyInMeters IS NULL)
  AND speciesKey IS NOT NULL
  AND NOT ARRAY_CONTAINS(issue, 'ZERO_COORDINATE')
  AND NOT ARRAY_CONTAINS(issue, 'COORDINATE_OUT_OF_RANGE')
  AND NOT ARRAY_CONTAINS(issue, 'COORDINATE_INVALID')
  AND NOT ARRAY_CONTAINS(issue, 'COUNTRY_COORDINATE_MISMATCH')
GROUP BY
  geogrid_id
"

occ_download_sql(sql) 

d <- occ_download_get('0045164-250811113504898') %>% 
    occ_download_import() |>
    mutate(geogrid_id = as.character(geogrid_id)) 

# make sure to use the correct resolution shapefile
sf_obj <- st_read("ISEA3H-shapefiles/resolution-6/")

dd <- merge(sf_obj, d, by = "geogrid_id") |> glimpse()

p <- ggplot() +
geom_sf(data=dd, aes(fill = unique_species_count)) +
scale_fill_viridis_c() +
theme_minimal()

ggsave(p, filename = "ISEA3H-shapefiles/grid_plot.svg", width = 12, height = 8)
```

![Grid Plot](grid_plot.svg)

## How I generated the shapefiles

I used the `ISEA3H.R` script to generate the shapefiles. The script uses the `geogrid-dem-1.0-SNAPSHOT.jar` file from the `geogrid` project to create the mapping from geodgrid_id to seqnum. I used  

I would advise against generating higher resolution grids my with `ISEA3H.R` and the `geogrid-dem-1.0-SNAPSHOT.jar` file unless absolutely necessary. Will probably take several hours to run. Most likely a batch version of the java call would be needed to speed up the process.

